From e4af497922607c320ba2096023f38a2db52ffb5d Mon Sep 17 00:00:00 2001
From: Guoguo <i@qwq.trade>
Date: Sat, 16 Sep 2023 21:30:21 +0800
Subject: [PATCH] Add support for riscv64, fix g++ error: '-march=native': ISA
 string must begin with rv32 or rv64 while compiling.

---
 miniapps/performance/CMakeLists.txt | 2 ++
 miniapps/performance/makefile       | 8 ++++++--
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/miniapps/performance/CMakeLists.txt b/miniapps/performance/CMakeLists.txt
index 4b38f658dff..e7bb650c9d3 100644
--- a/miniapps/performance/CMakeLists.txt
+++ b/miniapps/performance/CMakeLists.txt
@@ -14,6 +14,8 @@ if (${CMAKE_SYSTEM_PROCESSOR} MATCHES "ppc|ppc64" OR (APPLE AND "${CMAKE_OSX_ARC
    set(MFEM_PERF_CXX_ARCH_FLAGS "-mcpu=native" "-mtune=native")
 elseif (APPLE AND ${CMAKE_SYSTEM_PROCESSOR} MATCHES "arm64")
    set(MFEM_PERF_CXX_ARCH_FLAGS "-mcpu=apple-m1")
+elseif (${CMAKE_SYSTEM_PROCESSOR} MATCHES "riscv64")
+   set(MFEM_PERF_CXX_ARCH_FLAGS "-march=rv64gc")
 else()
    set(MFEM_PERF_CXX_ARCH_FLAGS "-march=native")
 endif()
diff --git a/miniapps/performance/makefile b/miniapps/performance/makefile
index 156cba75492..b16df05e36d 100644
--- a/miniapps/performance/makefile
+++ b/miniapps/performance/makefile
@@ -98,9 +98,13 @@ MFEM_PERF_CXXFLAGS_gcc_ppc = -mcpu=native -mtune=native\
 MFEM_PERF_CXXFLAGS_xlc = -mcpu=native
 
 # - Clang extra options:
-ifneq ($(MFEM_MACHINE),arm64)
+ifeq ($(MFEM_MACHINE),riscv64)
+  MFEM_PERF_CXXFLAGS_clang += -march=rv64gc
+  else
+    ifneq ($(MFEM_MACHINE),arm64)
   # -march=native is unavailable on clang/ARM64 as of 05/2021: support could be added later.
-  MFEM_PERF_CXXFLAGS_clang += -march=native
+      MFEM_PERF_CXXFLAGS_clang += -march=native
+    endif
 endif
 MFEM_PERF_CXXFLAGS_clang += $(PEDANTIC_FLAG) -Wall
 MFEM_PERF_CXXFLAGS_clang += -fcolor-diagnostics
